import time
import requests
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from webdriver_manager.chrome import ChromeDriverManager

# ì…€ë ˆë‹ˆì›€ ì˜µì…˜ ì„¤ì •
options = Options()
options.add_argument("--headless=new")  # í—¤ë“œë¦¬ìŠ¤ ë¸Œë¼ìš°ì €
options.add_argument("--disable-gpu")
options.add_argument("--window-size=1920,1080")
options.add_experimental_option("excludeSwitches", ["enable-logging"])

# ë“œë¼ì´ë²„ ì‹¤í–‰
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)

# ê²°ê³¼ ì €ì¥ìš© ë¦¬ìŠ¤íŠ¸
valid_links = []
headers = {"User-Agent": "Mozilla/5.0"}  # ìš”ì²­ ì°¨ë‹¨ ìš°íšŒìš© í—¤ë”
page = 1

print(f"\n[ğŸ“„ GrayhatWarfare ë²„í‚· ëª©ë¡ ìœ íš¨ ë§í¬ë§Œ ì €ì¥ ì‹œì‘]\n")

while True:
    print(f"\nğŸ“„ í˜ì´ì§€ {page} ------------------------------")
    base_url = f"https://buckets.grayhatwarfare.com/buckets?type=aws&page={page}"
    driver.get(base_url)
    time.sleep(2)

    try:
        rows = driver.find_elements(By.CSS_SELECTOR, "table.table tbody tr")
        if not rows:
            print("âœ… ë§ˆì§€ë§‰ í˜ì´ì§€ì…ë‹ˆë‹¤.")
            break

        for row in rows:
            cols = row.find_elements(By.TAG_NAME, "td")
            if len(cols) >= 3:
                name_tag = cols[1].find_element(By.TAG_NAME, "a")
                count_tag = cols[2].find_element(By.TAG_NAME, "a")

                name = name_tag.text.strip()
                count = count_tag.text.strip()
                url = name_tag.get_attribute("href")

                try:
                    # GET ìš”ì²­ìœ¼ë¡œ ì—°ê²° ì‹œë„ (stream=Trueë¡œ ë¹ ë¥´ê²Œ)
                    response = requests.get(url, headers=headers, timeout=8, stream=True)
                    if response.status_code == 200:
                        print(f"âœ… ì—°ê²° ê°€ëŠ¥: {url}")
                        valid_links.append(f"{name} | íŒŒì¼ ìˆ˜: {count} | {url}")
                    else:
                        print(f"âš ï¸ ì—°ê²° ì‹¤íŒ¨ ({response.status_code}): {url}")
                except requests.exceptions.RequestException as e:
                    print(f"âŒ ì˜ˆì™¸ ë°œìƒ ({type(e).__name__}): {url}")
    except Exception as e:
        print(f"âŒ í˜ì´ì§€ {page} í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")
        break

    page += 1

driver.quit()

# ê²°ê³¼ ì €ì¥
with open("valid_buckets.txt", "w", encoding="utf-8") as f:
    for line in valid_links:
        f.write(line + "\n")

print(f"\nâœ… ìœ íš¨í•œ {len(valid_links)}ê°œì˜ ë§í¬ë¥¼ valid_buckets.txtì— ì €ì¥í–ˆìŠµë‹ˆë‹¤!")
